name: Stats

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  update-waka:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch WakaTime ALL TIME stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          curl -s \
            -H "Authorization: Basic $(echo -n $WAKATIME_API_KEY | base64)" \
            https://wakatime.com/api/v1/users/current/stats/all_time \
            > waka.json

      - name: Generate language wheel
        run: |
          : > waka.md

          jq -r '
            (.data.languages // [])
            | sort_by(-.total_seconds)
            | .[:6]
            | .[]
            | .total_seconds as $s
            | ($s / 3600 | floor) as $h
            | (($s % 3600) / 60 | floor) as $m
            | .percent as $p
            | (
                if   $p >= 90 then "◉◉◉◉◉◉◉◉◉◉"
                elif $p >= 80 then "◉◉◉◉◉◉◉◉◉◯"
                elif $p >= 70 then "◉◉◉◉◉◉◉◉◯◯"
                elif $p >= 60 then "◉◉◉◉◉◉◉◯◯◯"
                elif $p >= 50 then "◉◉◉◉◉◉◯◯◯◯"
                elif $p >= 40 then "◉◉◉◉◉◯◯◯◯◯"
                elif $p >= 30 then "◉◉◉◉◯◯◯◯◯◯"
                elif $p >= 20 then "◉◉◉◯◯◯◯◯◯◯"
                elif $p >= 10 then "◉◉◯◯◯◯◯◯◯◯"
                else              "◉◯◯◯◯◯◯◯◯◯"
                end
              ) as $wheel
            | "- `\(.name)`  \($wheel)  \($h)h \($m)m"
          ' waka.json >> waka.md



      - name: Update README
        run: |
          awk '
            BEGIN {keep=1}
            /<!--START_SECTION:waka-->/ {
              print
              system("cat waka.md")
              keep=0
            }
            /<!--END_SECTION:waka-->/ {
              print
              keep=1
              next
            }
            keep==1 {print}
          ' README.md > README.tmp

          mv README.tmp README.md

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update WakaTime stats" || exit 0
          git push
